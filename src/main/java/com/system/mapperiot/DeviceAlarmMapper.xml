<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.system.mapperiot.DeviceAlarmMapper">
    <resultMap id="BaseResultMap" type="com.system.po.DeviceAlarmInfo">
        <!--  <result column="数据库字段名" property="实体类属性" jdbcType="数据库字段类型" />-->
        <id column="ALARM_ID" jdbcType="VARCHAR" property="dAlarmId"/>
        <result column="DEVICE_ID" jdbcType="VARCHAR" property="dSerialNum"/>
        <result column="DEVNAME" jdbcType="VARCHAR" property="dName"/>
        <result column="DEVORGID" jdbcType="VARCHAR" property="dOrgId"/>
        <result column="DEVORGNAME" jdbcType="VARCHAR" property="dOrgName"/>
        <result column="ALARM_CODE" jdbcType="VARCHAR" property="dAlarmCode"/>
        <result column="ALARM_DESCRIBE" jdbcType="VARCHAR" property="dAlarmInfo"/>
        <result column="ALARM_DATE" jdbcType="VARCHAR" property="dAlarmTime"/>
        <result column="ALARM_TYPE" jdbcType="VARCHAR" property="dAlarmType"/>
    </resultMap>
    <resultMap id="BaseHisResultMap" type="com.system.po.DeviceAlarmInfo">
        <!--  <result column="数据库字段名" property="实体类属性" jdbcType="数据库字段类型" />-->
        <id column="HISALARM_ID" jdbcType="VARCHAR" property="dAlarmId"/>
        <result column="DEVICE_ID" jdbcType="VARCHAR" property="dSerialNum"/>
        <result column="DEVNAME" jdbcType="VARCHAR" property="dName"/>
        <result column="DEVORGID" jdbcType="VARCHAR" property="dOrgId"/>
        <result column="DEVORGNAME" jdbcType="VARCHAR" property="dOrgName"/>
        <result column="HISALARM_CODE" jdbcType="VARCHAR" property="dAlarmCode"/>
        <result column="HISALARM_DESCRIBE" jdbcType="VARCHAR" property="dAlarmInfo"/>
        <result column="HISALARM_DATE" jdbcType="VARCHAR" property="dAlarmTime"/>
        <result column="ALARM_TYPE" jdbcType="VARCHAR" property="dAlarmType"/>
    </resultMap>
    <select id="selectDeviceRealAlarmCount" resultType="Integer">
      SELECT count(*) from iot_realalarm
    </select>
    <select id="selectDeviceRealAlarmCountByRoleId" resultType="Integer">
        select count(DISTINCT a.alarm_id)
        from iot_realalarm a,iot_devicerole b
        where a.device_id = b.devrole_devnum
        and b.devrole_roleid IN
        <foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    <select id="selectAlarmInfo" resultMap="BaseResultMap">
        select a.*, b.di_name as DEVNAME,c.node_id as DEVORGID,c.node_name as DEVORGNAME,'报警' ALARM_TYPE
        from iot_realalarm a,iot_deviceinfo b,iot_orgtreenode c
        where a.device_id = b.di_serialnum
        and b.di_nodeid = c.node_id
        order by a.alarm_date desc
    </select>
    <select id="selectAlarmInfoByRoleId" resultMap="BaseResultMap">
        select DISTINCT a.*, b.di_name as DEVNAME,c.node_id as DEVORGID,c.node_name as DEVORGNAME,'报警' ALARM_TYPE
        from iot_realalarm a,iot_deviceinfo b,iot_orgtreenode c,iot_devicerole d
        where a.device_id = b.di_serialnum
        and b.di_nodeid = c.node_id
        and d.devrole_devnum = a.device_id
        and d.devrole_roleid IN
        <foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        order by a.alarm_code desc
    </select>
    <select id="selectHisAlarmInfoByDate" resultMap="BaseHisResultMap">
        select a.*, b.di_name as DEVNAME,c.node_id as DEVORGID,c.node_name as DEVORGNAME,'报警' ALARM_TYPE
        from IOT_HISALARM a,iot_deviceinfo b,iot_orgtreenode c
        where a.device_id = b.di_serialnum
        and b.di_nodeid = c.node_id
        AND a.hisalarm_date BETWEEN to_date(#{sStartDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss')
        AND to_date(#{sEndDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss')
        order by a.hisalarm_date desc
    </select>
    <select id="selectHisAlarmInfoByDateAndRoleId" resultMap="BaseHisResultMap">
        select DISTINCT a.*, b.di_name as DEVNAME,c.node_id as DEVORGID,c.node_name as DEVORGNAME,'报警' ALARM_TYPE
        from IOT_HISALARM a,iot_deviceinfo b,iot_orgtreenode c,iot_devicerole d
        where a.device_id = b.di_serialnum
        and b.di_nodeid = c.node_id
        and d.devrole_devnum = a.device_id
        AND a.hisalarm_date BETWEEN to_date(#{sStartDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss')
        AND to_date(#{sEndDate,jdbcType=VARCHAR},'yyyy-mm-dd hh24:mi:ss')
        and d.devrole_roleid IN
        <foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
        order by a.hisalarm_date desc
    </select>
</mapper>